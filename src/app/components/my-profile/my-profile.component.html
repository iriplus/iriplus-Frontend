<form *ngIf="user" class="profile-form" (ngSubmit)="onSubmit($event)">
<div class="profile-container">
  <div class="profile-card">
    <!-- HEADER -->
    <div class="profile-header">
      <div class="avatar-container">
        <div class="avatar">
         <img *ngIf="user?.profile_picture; else defaultAvatar" [src]="user.profile_picture" class="avatar-img" alt="Profile picture"/>
          <ng-template #defaultAvatar>
            <svg class="avatar-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </ng-template>
        </div>
      </div>
      <h1 class="profile-title">My Profile</h1>
      <p class="profile-subtitle">View and update your personal information</p>
    </div>

    <!-- PROFILE FORM -->
    <form class="profile-form" (ngSubmit)="onSubmit($event)">
      <!-- First Name and Last Name -->
      <div class="name-group">
        <div class="form-group half-width">
          <label for="firstName" class="form-label">First Name</label>
          <div class="input-wrapper">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <input type="text" id="firstName" name="firstName" [(ngModel)]="user.name" class="form-input" placeholder="First Name" [disabled]="!isEditing" />
          </div>
        </div>

        <div class="form-group half-width">
          <label for="lastName" class="form-label">Last Name</label>
          <div class="input-wrapper">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <input type="text" id="lastName" name="lastName" [(ngModel)]="user.surname" class="form-input" placeholder="Last Name" [disabled]="!isEditing" />
          </div>
        </div>
      </div>

      <!-- Email and DNI -->
      <div class="name-group">
        <div class="form-group half-width">
          <label for="email" class="form-label">Email</label>
          <div class="input-wrapper">
            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
              <polyline points="22,6 12,13 2,6"></polyline>
            </svg>
            <input type="email" id="email" name="email" [(ngModel)]="user.email" class="form-input" placeholder="you@example.com" [disabled]="!isEditing" />
          </div>
        </div>

        <div class="form-group half-width">
          <label for="dni" class="form-label">DNI</label>
          <div class="input-wrapper">
            <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
              <polyline points="14 2 14 8 20 8" />
              <line x1="16" y1="13" x2="8" y2="13" />
              <line x1="16" y1="17" x2="8" y2="17" />
              <line x1="10" y1="9" x2="8" y2="9" />
            </svg>
            <input type="text" id="dni" name="dni" [(ngModel)]="user.dni" class="form-input" placeholder="DNI" [disabled]="true" />
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button *ngIf="!isEditing" type="button" class="edit-button" (click)="enableEdit()">
          <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
          </svg>
          Edit Profile
        </button>

        <div *ngIf="isEditing" class="edit-actions">
          <button type="submit" class="save-button">
            <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            Save Changes
          </button>
          <button type="button" class="cancel-button" (click)="cancelEdit()">
            <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Cancel
          </button>
        </div>
      </div>
    </form>

    <!-- Academic Information - Student -->
    <div *ngIf="isStudent">
      <div class="section-divider"></div>
      <div class="academic-section">
        <h2 class="section-title">Academic Information</h2>

        <div class="student-section">
          <!-- Sección de Nivel y XP -->
          <div class="level-card">
            <div class="level-header">
              <div class="level-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                </svg>
              </div>
              <div class="level-info">
                <span class="level-label">My Level</span>
                <span class="level-name">{{ currentLevel?.description || 'No nivel' }}</span>
              </div>
              <div class="xp-badge">
                <span class="xp-value">{{ accumulatedXp || 0 }}</span>
                <span class="xp-label">XP</span>
              </div>
            </div>

            <div class="progress-section">
              <div class="progress-labels">
                <span class="progress-current">{{ currentLevel?.description || 'Start' }}</span>
                <span class="progress-next">{{ nextLevel?.description || 'Maximum' }}</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar" [style.width.%]="progressPercentage"></div>
                <div class="progress-marker" [style.left.%]="progressPercentage">
                  <div class="marker-dot"></div>
                </div>
              </div>
              <div class="progress-xp-info">
                <span class="xp-current">{{ accumulatedXp || 0 }} XP</span>
                <span class="xp-needed" *ngIf="nextLevel">{{ nextLevel.min_xp }} XP para {{ nextLevel.description }}</span>
                <span class="xp-needed" *ngIf="!nextLevel">Maximum level reached</span>
              </div>
            </div>

            <div class="level-stats">
              <div class="stat-item">
                <div class="stat-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 20v-6M6 20V10M18 20V4" />
                  </svg>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ xpToNextLevel || 0 }}</span>
                  <span class="stat-label">XP remaining</span>
                </div>
              </div>
              <div class="stat-item">
                <div class="stat-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                    <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                    <path d="M4 22h16" />
                    <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22" />
                    <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
                    <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
                  </svg>
                </div>
                <div class="stat-content">
                  <span class="stat-value">{{ currentLevelIndex + 1 }}</span>
                  <span class="stat-label">de {{ totalLevels }} levels</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Sección de Clase -->
          <div class="class-card">
            <div class="class-header">
              <div class="class-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>
              </div>
              <h3 class="class-title">My Class</h3>
              <button class="btn-change-class" (click)="openChangeClassModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                  <path d="M3 3v5h5" />
                  <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
                  <path d="M16 16h5v5" />
                </svg>
               Change class
              </button>
            </div>

            <div class="class-content" *ngIf="currentClass; else noClass">
              <div class="class-code-badge">
                <span class="code-label">Code</span>
                <span class="code-value">{{ currentClass.class_code }}</span>
              </div>

              <div class="class-details">
                <div class="detail-row">
                  <span class="detail-label">Description</span>
                  <span class="detail-value">{{ currentClass.description || 'No description' }}</span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Suggested Level</span>
                  <span class="detail-value" [ngClass]="'level-' + currentClass.suggested_level.toLowerCase()">
                    {{ currentClass.suggested_level || 'Not specified' }}
                  </span>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Capacity</span>
                  <div class="capacity-info">
                    <div class="capacity-bar-container">
                      <div class="capacity-bar" [style.width.%]="classCapacityPercentage"></div>
                    </div>
                    <span class="capacity-text">{{ currentClass.students.length || 0 }} / {{ currentClass.max_capacity }} students</span>
                  </div>
                </div>
                <div class="detail-row">
                  <span class="detail-label">Teachers</span>
                    <span class="detail-value">
                      <ng-container *ngFor="let teacher of currentClass.teachers; let i = index">
                        {{ teacher.name }} {{ teacher.surname }}
                        <span *ngIf="i < currentClass.teachers.length - 1">, </span>
                      </ng-container>
                    </span>
                </div>
              </div>
            </div>

            <ng-template #noClass>
              <div class="no-class-message">
                <div class="no-class-icon">
                  <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                  </svg>
                </div>
                <p class="no-class-text">No estás inscripto en ninguna clase</p>
                <button class="btn-enroll" (click)="openChangeClassModal()">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14" />
                    <path d="M12 5v14" />
                  </svg>
                  Inscribirme a una clase
                </button>
              </div>
            </ng-template>
          </div>
         </div>

        <!-- Modal para cambiar de clase -->
        <div class="modal-overlay" *ngIf="showChangeClassModal" (click)="closeChangeClassModal()">
          <div class="modal-container" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h2 class="modal-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                  <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                </svg>
                Cambiar de Clase
              </h2>
              <button class="modal-close" (click)="closeChangeClassModal()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 6 6 18" />
                  <path d="m6 6 12 12" />
                </svg>
              </button>
            </div>

            <div class="modal-body">
              <div class="search-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8" />
                  <path d="m21 21-4.3-4.3" />
                </svg>
                <input type="text" placeholder="Buscar clase por código o descripción..." [(ngModel)]="classSearchTerm" (input)="filterClasses()" />
              </div>

              <div class="classes-list">
                <div class="class-option" *ngFor="let classItem of filteredClasses" [ngClass]="{'selected': selectedClassId === classItem.id, 'current': currentClass?.id === classItem.id}" (click)="selectClass(classItem)">
                  <div class="class-option-header">
                    <span class="class-option-code">{{ classItem.class_code }}</span>
                    <span class="class-option-level" [ngClass]="'level-' + classItem.suggested_level.toLowerCase()">
                      {{ classItem.suggested_level }}
                    </span>
                  </div>
                  <p class="class-option-description">{{ classItem.description || 'Sin descripción' }}</p>
                  <div class="class-option-footer">
                    <span class="class-option-capacity">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      </svg>
                      {{ classItem.students_count || 0 }}/{{ classItem.max_capacity }}
                    </span>
                    <span class="current-badge" *ngIf="currentClass?.id === classItem.id">Clase actual</span>
                  </div>
                </div>

                <div class="no-results" *ngIf="filteredClasses.length === 0">
                  <p>No se encontraron clases</p>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button class="btn-cancel" (click)="closeChangeClassModal()">Cancelar</button>
              <button class="btn-confirm" [disabled]="!selectedClassId || selectedClassId === currentClass?.id" (click)="confirmChangeClass()">
                Cambiar a esta clase
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

   <!-- Academic Information - Teacher -->
<div *ngIf="isTeacher">
  <div class="section-divider"></div>

  <div class="academic-section teacher-section">
    <h2 class="teacher-title">
      <div class="teacher-title-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
          <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
        </svg>
      </div>
      Classes You Teach
    </h2>

    <div *ngIf="user.teacher_classes?.length; else noTeacherClasses" class="teacher-classes-grid">
      <div *ngFor="let cls of user.teacher_classes" class="teacher-class-card">
        <div class="teacher-card-content">
          <div class="teacher-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
              <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
            </svg>
          </div>

          <div class="teacher-card-info">
            <p class="teacher-class-code">{{ cls.class_code }}</p>
            <p class="teacher-class-description" [title]="cls.description">
              {{ cls.description }}
            </p>

            <div class="teacher-class-meta">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
              </svg>
              <span>{{ cls.students_count || 0 }} students</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noTeacherClasses>
      <p class="no-teacher-classes">You have no assigned classes.</p>
    </ng-template>
  </div>
</div>




    <!-- Change Password Section -->
    <div class="section-divider"></div>
    <div class="password-section">
      <h2 class="section-title">Change Password</h2>
      <button type="button" class="secondary-button" (click)="changePassword()">
        <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        Change Password
      </button>
    </div>

    <!-- Danger Zone - Delete Account -->
    <div class="section-divider"></div>
    <div class="danger-section">
      <h2 class="section-title danger">Delete Account</h2>
      <p class="danger-text">
        Once you delete your account, there is no going back. Please be sure.
      </p>
      <button type="button" class="danger-button" (click)="confirmDeleteAccount()">
        <svg class="button-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
        Delete Account
      </button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div *ngIf="showDeleteModal" class="modal-overlay" (click)="closeDeleteModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <svg class="modal-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <h3 class="modal-title">Are you sure?</h3>
        </div>
        <p class="modal-text">
          This action cannot be undone. All your data will be permanently deleted and your account cannot be recovered.
        </p>
        <div class="modal-actions">
          <button type="button" class="modal-cancel-button" (click)="closeDeleteModal()">
            Cancel
          </button>
          <button type="button" class="modal-delete-button" (click)="deleteAccount()">
            Yes, delete my account
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
</form>
